\chapter{内存管理技术}
\label{cha:study}

\section{内存泄漏检测及回收}
\label{sec:studyLeak}

内存泄漏是指程序堆中已经动态分配的内存，由于某种原因未得到释放或无法释放，造成系统内存浪费，
最终可能导致一些严重后果\cite{Maebe04}。内存泄漏是隐蔽的，并且不断积累，与其他内存非法访问错误相比，更难检测。
内存泄漏通常不会产生直接可观察的错误症状，而是逐渐积累，降低系统性能，极端的情况下可能使系统崩溃。
特别对于嵌入式系统来说，内存泄漏往往使得系统失去使用价值。

目前与动态内存错误检测相关的方法主要有动态方法和静态方法两类。

\begin{compactitem}
\item
动态方法需要在程序运行过程中进行潜在错误的检测，
如Purify\footnote{IBM提供的工具，URL：http://www-306.ibm.com/software/awdtools/purify/}就是一个动态的单元测试工具。
Purify可以检测到程序中存在的内存泄漏问题，但对于其他的动态内存错误，如空指针的引用、
动态内存的重复释放等却无能为力。Purify需要在程序的运行中进行内存泄漏的检测，
由于程序中分支结构的存在，程序的一次运行不能覆盖所有的程序分支，从而在一定程度上降低了检错效率。
动态方法的一个缺点是常常会显著增加系统运行时的负荷。
\item
静态方法通过对程序结构的分析来检测程序中隐藏的动态内存错误，
如Lint\footnote{静态检测的工具，URL：http://docs.sun.com/source/806-3567/lint.html}、
Splint等都是通过在源程序中添加注释语句来检测应用程序中存在的潜在错误。
这些工具的检错效果与应用程序中的注释量有关，并且它们经常会给出错误的信息，影响错误检测工作的顺利进行。
\end{compactitem}

在嵌入式应用环境中，资源通常是非常有限的。特别对于嵌入式实时操作系统来说，性能和安全是至关重要的。
利用运行时的动态内存泄漏检测方法开销很大，所以不适用于在实际的嵌入式产品。
但是该方法可以使用在嵌入式系统的测试阶段，检测内存泄漏错误。静态方法则适用于嵌入式环境，
但由于其自身的缺点，能力有限。

对于动态内存泄漏检测方法，它常常是基于对动态内存跟踪\cite{Qin05}来实现的。对动态内存进行跟踪通常有三种方法：

\begin{compactitem}
\item
重写编译器。这种方法很费时并且代价很大，所以极少被采用。
\item
在程序执行或者链接的过程中直接插入目标代码。这种方法在不破坏程序逻辑和符号表的前提下，
往已经编译好的目标代码中插入动态内存跟踪指令。这种方法的不足之处在于其适用性不强，
在不同的指令集甚至不同的操作系统之间无法方便的移植。
\item
包装源代码。这种方法包括解析、分析及把原来的代码转化成新的代码。它比前面两种办法方便高效，
但对源代码的改变，难以保证不影响原来系统功能，需要更多的测试代价。
\end{compactitem}

为了回收泄漏内存，常常需要一个垃圾回收机制。由于考虑到嵌入式实时系统的性能，
不同的具体应用，往往实现不同的回收泄漏内存的机制。这些机制为了保证性能，并不需要非常复杂和全面。
一般来说，为了能够回收泄漏内存，系统必须对任务申请的内存块进行跟踪。

\section{内存容错及冗余技术}
\label{sec:studyDispatch}
容错技术是指系统对错误的容忍技术，指处于工作状态中的系统中一个或多个部分发生错误时，
系统能自动检测与诊断，并能采取相应的措施保证系统正常运行的技术\cite{Huang02}。
容错技术能够达到对错误的容忍，但并非无视错误的存在。它首先要能自适应地检测并诊断系统的错误，
然后采取对错误控制或处理的策略。因此容错技术包括以下两部分：

\begin{compactitem}
\item
系统错误检测与诊断。当系统产生错误时能自动发现系统错误，并确定出错误的类型、位置、原因等。
故障检测与诊断的成功与否直接影响系统的容错能力和可靠性，它是自适应运行的。
\item
系统错误控制与决策。它针对错误的类型、位置、原因等信息采取相应的容错处理，
在检测与诊断出系统的错误后立即决策出处理错误的方案并采取行动。
目前常采用的处理方案是通过冗余资源来置换错误的单元，使系统继续正常工作。
\end{compactitem}

简单地说，冗余就是指多余的资源。当系统中的一部分出现错误时，
可以由冗余的部分顶替错误的部分工作，以保证系统在规定的时间内完成任务\cite{Huang02}。
冗余主要分为硬件冗余、软件冗余、信息冗余和时间冗余：

\begin{compactdesc}
\item[硬件冗余]
指系统中某个或几个关键单元除了工作所需的基本单元外，另外设置一个或者一个以上的冗余单元。
这些冗余单元可以与工作单元同时工作，也可以处于等待状态。
一旦工作单元出现错误就可以顶替错误单元继续工作。硬件冗余是系统容错技术的基础。
\item[软件冗余]
通常针对计算机系统而言，将关键的软件部件复制多份保存在存储器。
\item[信息冗余]
指利用各种传感器或多种系统之间存在的已知函数关系来产生冗余信息，
从而实现检测和识别错误。这种冗余多用于动态容错技术中的错误检测。
\item[时间冗余]
指重复执行某段程序的方法来检测错误或使系统从错误中恢复工作。
\end{compactdesc}

冗余设计是提高系统安全性与可靠性的一种方式，当采用其它方法不能满足系统可靠性要求时，
可以考虑采用冗余设计。不过冗余设计需要更多的资源。

由于嵌入式实时应用常用于工控、航天等领域中，可能会面临恶劣的工作环境。
比如在航天应用中，系统可能会受到宇宙射线等电磁干扰，导致内存信息发生翻转，破坏数据的一致性。
对于一些关键的数据，这样的翻转可能会导致灾难性的后果，使系统发生不可预测的行为，更严重的可能导致系统崩溃。
因此，在嵌入式实时操作系统中，对关键数据的保护显得尤为重要。这种保护常可通过内存冗余分配和内存冗余编码功能来实现。

\begin{compactitem}
\item
内存冗余分配是针对系统中的关键数据，在内存中分配若干块冗余内存，以达到容错目的。
当内存中关键数据因为某些原因发生错误时，系统可以通过一定方法，从冗余块中恢复关键数据。
在这方面，还需要制定相应的比对策略和同步技术。
\item
内存冗余编码是指对系统中关键数据增加校验码，通过校验码来对内存关键数据进行检错和纠错。
常用的编码如海明码，可以满足内存冗余编码的需求。
\end{compactitem}

\section{内存保护技术}
\label{sec:studyProtect}

在嵌入式实时系统内存管理中，要实现内存的保护，常常依赖于内存管理单元（MMU）。
MMU负责将内存的逻辑地址转换为物理地址，保护内存不会被非法访问。
本节所讨论的正是基于MMU的内存页面保护技术。
如图\ref{fig:mmu}为高速缓存的MMU存储器系统\footnote{该图来自于浙大嵌入式系统硕士课程内存管理课件，陈天洲教授。}。
\begin{figure}[h]\centering
  \wuhao
  \includegraphics[width=0.90\textwidth]{mmu.eps}
  \caption{高速缓存的MMU存储器系统}\label{fig:mmu}
\end{figure}

在嵌入式实时系统内存管理中，对内存的保护主要有：

\begin{itemize}
\item
任务堆栈段的保护。任务的堆栈段通常存放在一个全局区域内，如果不采取任何措施的话，可以被其他任务访问改写。
这种保护可以通过MMU支持，任务通过改变内存页面属性实现。
\item
中断向量表的保护。在嵌入式系统运行中的内核模式下，应用程序可能对中断向量表非法改写，
这也是容易发生的一个错误。这可以设置中断向量表所在内存页面属性为不可写。
非法访问将产生一个TLB错误。
\item
代码段的保护。如果程序代码段被意外修改，可能会导致致命的错误。
这极易因为内存溢出等原因发生，也可能被人为地利用修改。这同样可通过设置代码段页面不可写实现。
\item
共享数据的保护。任务之间经常需要以在保护状态下共享数据。需要这种保护的例子很多，
比如经典的生产者－消费者模型。实现这种保护的方法也很多，比如信号量、监视器等。
\end{itemize}
